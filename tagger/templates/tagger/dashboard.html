{% extends "tagger/base.html" %}

{% block script %}
<script src="../../static/js/table/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="../../static/js/table/dataTables.bootstrap4.min.js" type="text/javascript"></script>
{% endblock %}

{% block body_block %}
<script>
    var data;
    $(document).ready(function(){
        // Develop mode
        // var conv = getIntitalData();
        // var conv_list = [];
        // for (c in conv){
        //     console.log('conv = ' + c);
        //     conv_list.push({'name': conv[c]['name'], 'sentence': conv[c]['sentences'][1]['text']});
        //     console.log({'name': conv[c]['name'], 'sentence': conv[c]['sentences'][1]['text']});
        // }
        // Actual data from rest api
        $('#conv_table').DataTable( {
            "ajax": {
                'url': 'http://172.23.148.117:8000/api/dialog/',
                "dataSrc": function(json){
                    
                    let conv_list = [];
                    console.log('count = ' + json['count'])
                    data = json['results'];
                    for (c in data){
                        console.log('json 1 = ' + c);
                        conv_list.push({'id': data[c]['id'], 'name': data[c]['name'], 'sentence': data[c]['sentences'][1]['text']});
                        console.log({'id': data[c]['id'], 'name': data[c]['name'], 'sentence': data[c]['sentences'][1]['text']});
                    }
                    return conv_list;
                }
            },
            "columns": [
                { "data": "id" },
                { "data": "name" },
                { "data": "sentence" },
            ]
        });

        $("#conv_table").delegate("tr[role='row']", "click", function(){
            // Get ID for selected conversation
            selected_conv_id = $(this).closest('tr').find('.sorting_1').text();
            selected_conv = {};
            console.log('selected conv id = ' + selected_conv_id);
            $.each(data, function(value){
                if (data[value]['id'].toString() === selected_conv_id){
                    selected_conv = data[value];
                }
            });

            console.log('selected conv = ' + JSON.stringify(selected_conv));

            $.ajax({
                type: 'GET',
                url: "{% url 'tagger:conv_tagger' %}",
                data: {
                    'conv': JSON.stringify(selected_conv),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function(data){
                    console.log('success');
                    window.location = '/tagger/conv_tagger'+'?conv=' + JSON.stringify(selected_conv);
                },
            })
        });
    });

    function getIntitalData(){
        var value= $.ajax({ 
            url: '../../static/data/conv_1.json', 
            async: false
        }).responseText;
        return JSON.parse(value);
    }
</script>

<div class="col-md-8">
    <table id="conv_table" class="table table-striped table-bordered" style="width:100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Sentence</th>
            </tr>
        </thead>
    </table>
            
</div>

{% endblock %}