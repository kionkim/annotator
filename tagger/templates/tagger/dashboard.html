{% extends "tagger/base.html" %}

{% block script %}
<script src="../../static/js/table/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="../../static/js/table/dataTables.bootstrap4.min.js" type="text/javascript"></script>
{% endblock %}

{% block body_block %}
<script>
    var data;
    $(document).ready(function(){
        // Develop mode
        // var conv = getIntitalData();
        // var conv_list = [];
        // for (c in conv){
        //     console.log('conv = ' + c);
        //     conv_list.push({'name': conv[c]['name'], 'sentence': conv[c]['sentences'][1]['text']});
        //     console.log({'name': conv[c]['name'], 'sentence': conv[c]['sentences'][1]['text']});
        // }

        $('#conv_table').DataTable( { 
            "ajax": {
                //'url': 'http://172.23.148.117:9200/twd_index/_search?from=0&size=10',
                'url': '../../static/data/conv.json',
                "cache": true,
                "dataSrc": function(json){
                    console.log(json);
                    let conv_list = [];
                    console.log('count = ' + json['hits']['hits']);
                    data = json['hits']['hits'];
                    for (c in data){
                        conv_list.push({'id': data[c]['_id'], 
                                        'name': data[c]['_source']['name'], 
                                        'sentence': data[c]['_source']['sentences'][0]['text']});
                        console.log({'id': data[c]['_id'], 
                                        'name': data[c]['_source']['name'], 
                                        'sentence': data[c]['_source']['sentences'][0]['text']
                        });
                    }
                    return conv_list;
                }
            },
            "columns": [
                { "data": "id" },
                { "data": "name" },
                { "data": "sentence" },
            ]
        });
        
        $('#intent_table').DataTable( { 
            "ajax": {
                //'url': '../../static/data/intent.json',
                "url": "{% url 'tagger:get_intent' %}",
                "cache": true,
                "dataSrc": function(json){
                    console.log('intent from django = ' + json);
                    let intent_list = [];
                    $.each(json, function(i, a){
                        intent_list.push({'id':a["fields"]["intent_id"], 'name':a["fields"]["intent"]});
                    });
                    return intent_list;
                }
            },
            "columns": [
                { "data": "id" },
                { "data": "name" },
            ]
        });

        $('#act_table').DataTable( { 
            "ajax": {
                'url': "{% url 'tagger:get_act' %}",
                "cache": true,
                "dataSrc": function(json){
                    let act_list = [];
                    $.each(json, function(i, a){
                        act_list.push({'id':a["fields"]["act_id"], 'name':a["fields"]["act"]});
                    });
                    return act_list;
                }
            },
            "columns": [
                { "data": "id" },
                { "data": "name" },
            ]
        });

        $("#conv_table").delegate("tr[role='row']", "click", function(){
            // Get ID for selected conversation
            selected_conv_id = $(this).closest('tr').find('.sorting_1').text();
            selected_conv_with_id = {};
            selected_conv = [];
            $.each(data, function(value){
                if (data[value]['_id'] === selected_conv_id){
                    selected_conv_with_id['id'] = data[value]['_source']['name'];
                    _selected_conv = data[value]['_source']['sentences'];
                    $.each(_selected_conv, function(value){
                        console.log(_selected_conv[value]['speaker']);
                        _selected_conv[value]['text'] = _selected_conv[value]['text'].replace(/\n/g, '').replace(/"/g, '\'');
                        if(_selected_conv[value]['speaker'] !== 'System'){
                            console.log(_selected_conv[value]['created_date'].replace(/:/g,'-'));
                            _selected_conv[value]['created_date'] = _selected_conv[value]['created_date'].replace(/:/g,'-');
                            selected_conv.push(_selected_conv[value]);
                        }
                    });
                }
            });
            selected_conv_with_id['sentences'] = selected_conv;
            console.log('selected conv = ' + JSON.stringify(selected_conv_with_id));

            $.ajax({
                type: 'GET',
                url: "{% url 'tagger:conv_tagger' %}",
                data: {
                    'conv': JSON.stringify(selected_conv),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function(data){
                    console.log('success');
                    window.location = '/tagger/conv_tagger'+'?conv=' + JSON.stringify(selected_conv_with_id);
                },
            });


        });
    });

    function getIntitalData(){
        var value= $.ajax({ 
            url: '../../static/data/conv_1.json', 
            async: false
        }).responseText;
        return JSON.parse(value);
    }
</script>


<div class='row'>
    <div class="col-md-7">
        <h3>Assigned conversations</h3>
        <table id="conv_table" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>First Sentence</th>
                </tr>
            </thead>
        </table>
    </div>
    
    <div class="col-md-5">
        <div>
            <h3> Intents</h3>
            <table id="intent_table" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>Intent ID</th>
                        <th>Intent</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div>
            <h3>Acts</h3>
            <table id="act_table" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>Act ID</th>
                        <th>Act</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

{% endblock %}